{
  "name": "Quote Sync Refactor",
  "branchName": "feature/quote-sync-refactor",
  "userStories": [
    {
      "id": "US-001",
      "title": "Adopt canonical assetIds for sync targeting end-to-end",
      "description": "As a developer, I want all market-data sync requests to target canonical asset IDs (e.g., SEC:AAPL:XNAS, EUR:USD) so the backend syncs the correct instrument (ticker+MIC/qualifier) and the API is unambiguous.",
      "acceptanceCriteria": [
        "Frontend passes asset.id (not asset.symbol) to market-data sync actions",
        "Tauri payloads rename symbols -> assetIds and all emitters updated",
        "Web API request bodies rename symbols -> assetIds and all producers updated",
        "Core sync entry points accept assetIds and do not accept ticker-only targeting",
        "FX targeting uses FX:BASE:QUOTE format (no BASE/QUOTE, no BASEQUOTE=X in targeting lists)"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T16:30:00.000Z",
      "dependsOn": []
    },
    {
      "id": "US-002",
      "title": "Make incremental sync honor targeted assetIds",
      "description": "As a user, when I click "Update quotes" for a specific security, I want the app to sync only that asset (and any required FX pairs), not the entire portfolio.",
      "acceptanceCriteria": [
        "Incremental sync supports assetIds: Some(list) and syncs only the listed assets",
        "Ineligible assets (manual pricing/unsupported kinds) are skipped but reported via AssetSkipReason",
        "Both desktop and web runtimes route targeted update to incremental sync (not global sync)",
        "Asset page "Update quotes" updates the selected asset without syncing unrelated assets"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "dependsOn": [
        "US-001"
      ]
    },
    {
      "id": "US-003",
      "title": "Introduce explicit SyncMode (Incremental, RefetchRecent, BackfillHistory)",
      "description": "As a developer, I want one planner implementation with explicit modes so behavior is deterministic and user-visible actions map to clear semantics (recent refresh vs history rebuild).",
      "acceptanceCriteria": [
        "Core supports SyncMode::Incremental",
        "Core supports SyncMode::RefetchRecent { days } (defaults to QUOTE_HISTORY_BUFFER_DAYS)",
        "Core supports SyncMode::BackfillHistory { days } (defaults to DEFAULT_HISTORY_DAYS)",
        "/market-data/sync/history uses BackfillHistory and preserves its intent",
        "UI actions map explicitly: Update quotes -> Incremental; Refetch recent -> RefetchRecent; Rebuild history -> BackfillHistory",
        "SyncMode is a per-request/job parameter (not persisted in settings)"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T16:30:00.000Z",
      "dependsOn": []
    },
    {
      "id": "US-004",
      "title": "Add MarketSyncMode to portfolio jobs and remove implicit syncing",
      "description": "As a developer, I want portfolio recalculation jobs to declare whether market sync runs, so non-market changes don't accidentally trigger provider calls or large sync windows.",
      "acceptanceCriteria": [
        "Portfolio jobs support MarketSyncMode::None (recalc only)",
        "Portfolio jobs support MarketSyncMode::Incremental { asset_ids }",
        "Portfolio jobs support MarketSyncMode::RefetchRecent { asset_ids, days } and BackfillHistory { asset_ids, days }",
        "Goals/limits updates run recalc-only without market sync",
        "Manual exchange-rate CRUD runs recalc-only without market sync",
        "MarketSyncMode is a per-job parameter (not persisted in settings)"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-005",
      "title": "Converge web and desktop activity-triggered behavior to incremental targeted sync",
      "description": "As a user, activity changes should update the impacted instruments consistently across desktop and web, without global refetch-all behavior.",
      "acceptanceCriteria": [
        "Desktop activity-triggered jobs use targeted incremental sync with impacted assetIds",
        "Web activity-triggered jobs use targeted incremental sync with impacted assetIds",
        "No implicit refetch-all for activity-triggered jobs",
        "FX pairs derived from activity/account currency differences are targeted as FX asset IDs (FX:BASE:QUOTE)"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T17:00:00.000Z",
      "notes": "Verified: Both desktop and web use MarketSyncMode::Incremental with collected asset_ids",
      "dependsOn": [
        "US-001",
        "US-002",
        "US-004"
      ]
    },
    {
      "id": "US-006",
      "title": "Define FX history horizon for full recomputation jobs",
      "description": "As a user, base-currency changes and full history recalculations should have FX coverage across the entire computed history window so valuations don't fail or fall back unexpectedly.",
      "acceptanceCriteria": [
        "For full history recomputation jobs, FX history_start_date is earliest activity date via get_earliest_activity_date_global()",
        "For incremental jobs, FX does not backfill by default; it continues from last_quote_date",
        "FX targeting lists use FX asset IDs (FX:BASE:QUOTE)",
        "Base currency change triggers BackfillHistory mode for proper FX coverage"
      ],
      "priority": 1,
      "passes": true,
      "completedAt": "2026-01-21T17:00:00.000Z",
      "notes": "Added FX-specific handling in calculate_date_range_for_mode(), base currency change uses BackfillHistory",
      "dependsOn": [
        "US-003",
        "US-005"
      ]
    },
    {
      "id": "US-007",
      "title": "Remove listener-level sync-state mutations to eliminate races",
      "description": "As a developer, I want sync state to be updated deterministically by core sync/snapshot flows, not by spawned listener tasks, so timing cannot cause incorrect start dates or refetch windows.",
      "acceptanceCriteria": [
        "Desktop listener no longer spawns handle_activity_created/handle_activity_deleted to mutate quote_sync_state",
        "Sync planning does not depend on listener-timing for correctness",
        "Activity creation followed immediately by portfolio job cannot trigger large unintended backfills due to missing state"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "dependsOn": []
    },
    {
      "id": "US-008",
      "title": "Derive open/closed position transitions from snapshot calculation",
      "description": "As a user, closed positions should stop syncing after a grace period while preserving confirmation/catch-up near the close date, without relying on manual steps.",
      "acceptanceCriteria": [
        "Snapshot calculation calls update_position_status_from_holdings() to persist transitions",
        "Closed positions continue syncing only within CLOSED_POSITION_GRACE_PERIOD_DAYS (30)",
        "After grace period, SyncCategory::Closed returned to skip sync",
        "Re-opening a position marks asset active again via mark_asset_active()"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T17:00:00.000Z",
      "notes": "Added update_position_status_from_holdings() to QuoteService, called from both desktop and web after TOTAL snapshot calculation",
      "dependsOn": []
    },
    {
      "id": "US-009",
      "title": "Add incremental overlap window to heal provider corrections",
      "description": "As a user, recent quote history should self-heal from provider corrections and corporate actions by re-fetching a small overlap window and relying on idempotent upserts.",
      "acceptanceCriteria": [
        "Introduce OVERLAP_DAYS (3â€“7) and use it for incremental sync start dates",
        "Windows are inclusive [start, end] and allow duplicates",
        "Backfill windows avoid boundary double-fetch by using end = quote_min_date - 1 day when inclusive",
        "Upserts remain idempotent and do not create duplicate rows"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "notes": "OVERLAP_DAYS=5 added in constants.rs and used in calculate_date_range()",
      "dependsOn": []
    },
    {
      "id": "US-010",
      "title": "Handle SQLite parameter limits for large assetId sets",
      "description": "As a user with a large portfolio, syncing many assets should not fail due to SQLite bind parameter limits in IN (...) queries.",
      "acceptanceCriteria": [
        "Any aggregated bounds queries over assetIds are chunked via SQLITE_MAX_PARAMS_CHUNK=500",
        "Sync-all and large batch quote queries do not exceed SQLite parameter limits",
        "Behavior is covered by unit tests in storage-sqlite/src/utils.rs"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "notes": "Added chunk_for_sqlite utility, applied to market_data, assets, and sync_state repositories",
      "dependsOn": []
    },
    {
      "id": "US-011",
      "title": "Make sync-state quote bounds updates monotonic and crash-safe",
      "description": "As a developer, I want quote bounds in quote_sync_state to stay consistent with the quotes table even under crashes and retries.",
      "acceptanceCriteria": [
        "earliest_quote_date updates are monotonic (MIN(existing, new)) via SQL CASE",
        "last_quote_date updates are monotonic (MAX(existing, new)) via SQL CASE",
        "Bounds updates are atomic within single SQL UPDATE statement",
        "No scenario exists where quotes are written but bounds regress"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T16:45:00.000Z",
      "notes": "Added update_quote_bounds_monotonic method with SQL-level MIN/MAX semantics",
      "dependsOn": []
    },
    {
      "id": "US-012",
      "title": "Prevent duplicate sync work via per-asset locking and job coalescing",
      "description": "As a user, rapid edits/imports should not trigger redundant provider calls or overlapping sync jobs that compete and waste time.",
      "acceptanceCriteria": [
        "Only one in-flight sync pipeline per asset_id at a time via SYNC_LOCKS HashSet",
        "Concurrent triggers for same asset are skipped (not blocked) with SyncInProgress reason",
        "Lock uses scopeguard for RAII release on all exit paths",
        "System remains responsive under bursty activity edits"
      ],
      "priority": 3,
      "passes": true,
      "completedAt": "2026-01-21T17:15:00.000Z",
      "notes": "Added try_acquire_sync_lock/release_sync_lock with scopeguard, AssetSkipReason::SyncInProgress variant",
      "dependsOn": []
    },
    {
      "id": "US-013",
      "title": "Update documentation and settings UX for history rebuild vs recent refetch",
      "description": "As a user, I want clear controls for refreshing recent quotes versus rebuilding long history so actions match expectations.",
      "acceptanceCriteria": [
        "Settings/UI renamed: 'Refetch all' -> 'Rebuild History' with clear dialog explanation",
        "Dashboard actions renamed: 'Update Market Data' -> 'Update Quotes', 'Recalculate Portfolio' -> 'Rebuild Full History'",
        "recalculate_portfolio command now uses BackfillHistory mode (not Incremental)",
        "No sync mode stored in Settings - always per-action"
      ],
      "priority": 3,
      "passes": true,
      "completedAt": "2026-01-21T17:15:00.000Z",
      "notes": "Updated market-data-settings.tsx, dashboard-actions.tsx, portfolio-update-trigger.tsx, app-launcher.tsx",
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-014",
      "title": "Add tests for planner semantics, FX horizon, and targeted sync",
      "description": "As a developer, I want tests that cover the new sync modes, targeting behavior, FX horizon, and overlap logic so regressions are caught early.",
      "acceptanceCriteria": [
        "Unit tests cover: Incremental, RefetchRecent, BackfillHistory mode planning in sync.rs",
        "Tests cover targeted assetIds vs sync-all selection semantics",
        "Tests cover FX asset detection and backfill design documentation",
        "Tests verify OVERLAP_DAYS (5), BUFFER_DAYS (45), DEFAULT_HISTORY_DAYS (1825) constants",
        "Chunking tests already exist in storage-sqlite/src/utils.rs"
      ],
      "priority": 2,
      "passes": true,
      "completedAt": "2026-01-21T17:15:00.000Z",
      "notes": "Added 30+ tests covering SyncMode, MarketSyncMode, AssetSkipReason, date ranges, targeting, grace period",
      "dependsOn": [
        "US-001",
        "US-003"
      ]
    }
  ],
  "metadata": {
    "updatedAt": "2026-01-21T17:45:00.000Z",
    "source": "specs/prd-quote-sync-refactor.md",
    "completedAt": "2026-01-21T17:45:00.000Z",
    "status": "ALL_COMPLETE",
    "additionalCleanup": {
      "completed": [
        "Renamed get_assets_by_symbols -> get_assets_by_asset_ids in trait/impl/callers",
        "Updated frontend type-bridge syncMarketData(symbols -> assetIds)",
        "Renamed LatestQuotesBody.symbols -> asset_ids in web API with serde rename",
        "Updated get_latest_quotes commands to use asset_ids parameter"
      ],
      "technicalDebt": [
        "QuoteStore.get_latest_quotes/get_latest_quotes_pair still use 'symbols' param name (marked deprecated, prefer latest_batch/latest_with_previous with AssetId)",
        "handle_activity_created/handle_activity_deleted methods remain in QuoteSyncService but are no longer called from listeners",
        "refresh_activity_dates_from_activities/refresh_earliest_quote_dates still called in sync.rs (PRD marked as optional follow-up)"
      ]
    }
  }
}
