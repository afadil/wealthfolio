import { TradeMatcher } from "./trade-matcher"
import type { ActivityDetails, ActivityType, DataSource } from "@wealthfolio/addon-sdk"

const jsonActivities = `[{"id":"98be2bd1-bfbe-43c4-befa-4061b52b028d","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"NVDA","activityType":"SELL","date":"2025-08-25T04:00:00+00:00","quantity":"200","unitPrice":"181.6","currency":"USD","fee":"0","amount":"36320","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451211+00:00","updatedAt":"2025-08-25T22:38:05.451211+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"NVDA","assetName":"NVIDIA Corporation","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"579f5af7-8953-453f-bd86-f60c776b894f","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"TQQQ","activityType":"SELL","date":"2025-08-25T04:00:00+00:00","quantity":"100","unitPrice":"90.82","currency":"USD","fee":"0","amount":"9082","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451232+00:00","updatedAt":"2025-08-25T22:38:05.451232+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"TQQQ","assetName":"ProShares UltraPro QQQ","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"63f5e0e3-c7cb-4c1b-8a6c-3340d36188b1","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"NVDA","activityType":"BUY","date":"2025-08-20T04:00:00+00:00","quantity":"200","unitPrice":"170.5","currency":"USD","fee":"0","amount":"34100","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451260+00:00","updatedAt":"2025-08-25T22:38:05.451260+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"NVDA","assetName":"NVIDIA Corporation","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"5d18ede2-d029-4fc2-8564-22eaabd05776","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"AAPL","activityType":"SELL","date":"2025-08-06T04:00:00+00:00","quantity":"170","unitPrice":"214.95","currency":"USD","fee":"0","amount":"36541.5","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451288+00:00","updatedAt":"2025-08-25T22:38:05.451288+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"AAPL","assetName":"Apple Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"ba39f1f8-c31e-4bec-ab61-42ce7e7332c1","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"SHOP.TO","activityType":"SELL","date":"2025-07-02T04:00:00+00:00","quantity":"220","unitPrice":"158.8","currency":"CAD","fee":"0","amount":"34936","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451299+00:00","updatedAt":"2025-08-25T22:38:05.451299+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"SHOP.TO","assetName":"Shopify Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"5b21e135-1863-4f73-95c2-51f4a543ae6e","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"AMZN.TO","activityType":"BUY","date":"2025-07-01T04:00:00+00:00","quantity":"1000","unitPrice":"25.32","currency":"CAD","fee":"0","amount":"25320","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451310+00:00","updatedAt":"2025-08-25T22:38:05.451310+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"AMZN.TO","assetName":"Amazon.com, Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"40e6f331-4a11-49b9-afb1-6a81445ccbde","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"SHOP.TO","activityType":"BUY","date":"2025-06-12T04:00:00+00:00","quantity":"220","unitPrice":"148.7","currency":"CAD","fee":"0","amount":"32713.999999999996","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451330+00:00","updatedAt":"2025-08-25T22:38:05.451330+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"SHOP.TO","assetName":"Shopify Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"b29692af-cd12-4667-b3e0-34c9de204fa8","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"GOOGL.TO","activityType":"SELL","date":"2025-05-28T04:00:00+00:00","quantity":"1000","unitPrice":"29","currency":"CAD","fee":"0","amount":"29000","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451342+00:00","updatedAt":"2025-08-25T22:38:05.451342+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"GOOGL.TO","assetName":"GOOGL.TO","assetDataSource":"MANUAL","isSelected":false,"hasSwingTag":false},{"id":"146aa827-1d71-4245-8f29-de8e7ff93400","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"TQQQ","activityType":"BUY","date":"2025-05-14T04:00:00+00:00","quantity":"100","unitPrice":"69.37","currency":"USD","fee":"0","amount":"6937","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451352+00:00","updatedAt":"2025-08-25T22:38:05.451352+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"TQQQ","assetName":"ProShares UltraPro QQQ","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"a80ce986-f152-4e99-b5bf-aed933cae2ed","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"VFV.TO","activityType":"BUY","date":"2025-05-14T04:00:00+00:00","quantity":"200","unitPrice":"145.65","currency":"CAD","fee":"0","amount":"29130","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451362+00:00","updatedAt":"2025-08-25T22:38:05.451362+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"VFV.TO","assetName":"Vanguard S&P 500 Index ETF","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"b677a133-34cf-42ed-95cf-6f693c920a88","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"SHOP.TO","activityType":"SELL","date":"2025-05-12T04:00:00+00:00","quantity":"222","unitPrice":"145","currency":"CAD","fee":"0","amount":"32190","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451373+00:00","updatedAt":"2025-08-25T22:38:05.451373+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"SHOP.TO","assetName":"Shopify Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"3f77480b-1cbb-42da-a954-9052dbf4059f","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"GOOGL.TO","activityType":"BUY","date":"2025-05-07T04:00:00+00:00","quantity":"1000","unitPrice":"24.85","currency":"CAD","fee":"0","amount":"24850","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451383+00:00","updatedAt":"2025-08-25T22:38:05.451383+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"GOOGL.TO","assetName":"GOOGL.TO","assetDataSource":"MANUAL","isSelected":false,"hasSwingTag":false},{"id":"b0951d71-a17d-4843-acd6-e9bc7810d07f","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"SHOP.TO","activityType":"BUY","date":"2025-05-06T04:00:00+00:00","quantity":"222","unitPrice":"130.4","currency":"CAD","fee":"0","amount":"28948.800000000003","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451394+00:00","updatedAt":"2025-08-25T22:38:05.451394+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"SHOP.TO","assetName":"Shopify Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"3a7382dd-df19-4e81-badb-79b97980da16","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"AAPL","activityType":"BUY","date":"2025-05-02T04:00:00+00:00","quantity":"170","unitPrice":"204.7","currency":"USD","fee":"0","amount":"34799","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451406+00:00","updatedAt":"2025-08-25T22:38:05.451406+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"AAPL","assetName":"Apple Inc.","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"673c250f-44a3-4aab-b1a7-307bc3bdc60d","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"NVDA","activityType":"SELL","date":"2025-05-02T04:00:00+00:00","quantity":"365","unitPrice":"115","currency":"USD","fee":"0","amount":"41975","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451417+00:00","updatedAt":"2025-08-25T22:38:05.451417+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"NVDA","assetName":"NVIDIA Corporation","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"c3aa09f0-a7f6-4a59-8082-673667121586","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"NVDA","activityType":"BUY","date":"2025-04-16T04:00:00+00:00","quantity":"355","unitPrice":"100.8","currency":"USD","fee":"0.01","amount":"35784","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451427+00:00","updatedAt":"2025-08-25T22:38:05.451427+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"NVDA","assetName":"NVIDIA Corporation","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false},{"id":"3c9d54ef-7c56-47d8-bebe-a80fd705f517","accountId":"afc3c069-2108-450c-a4ab-1fdb0d50b6d3","assetId":"NVDA","activityType":"BUY","date":"2025-01-28T05:00:00+00:00","quantity":"10","unitPrice":"118","currency":"USD","fee":"0","amount":"1180","isDraft":true,"comment":null,"createdAt":"2025-08-25T22:38:05.451439+00:00","updatedAt":"2025-08-25T22:38:05.451439+00:00","accountName":"SWING-TEST","accountCurrency":"CAD","assetSymbol":"NVDA","assetName":"NVIDIA Corporation","assetDataSource":"YAHOO","isSelected":false,"hasSwingTag":false}]`;

const rawActivities = JSON.parse(jsonActivities);

const activities: ActivityDetails[] = rawActivities.map((a: any) => ({
    ...a,
    date: new Date(a.date),
    createdAt: new Date(a.createdAt),
    updatedAt: new Date(a.updatedAt),
    quantity: parseFloat(a.quantity),
    unitPrice: parseFloat(a.unitPrice),
    fee: parseFloat(a.fee),
    amount: parseFloat(a.amount),
    activityType: a.activityType as ActivityType,
    assetDataSource: a.assetDataSource as DataSource,
}));

export function testTradeMatcher() {
  console.log("=== Trade Matcher Test with embedded data ===");
  console.log(`Processing ${activities.length} activities...`);

  console.log("\n--- AVERAGE Method ---");
  const avgMatcher = new TradeMatcher({ lotMethod: "AVERAGE", includeFees: true });
  const avgResult = avgMatcher.matchTrades(activities);
  
  const totalPLAvg = avgResult.closedTrades.reduce((sum, trade) => sum + trade.realizedPL, 0);
  console.log("Total Realized P/L (AVERAGE):", totalPLAvg);
  
  const mayTradesAvg = avgResult.closedTrades.filter(t => t.exitDate.getFullYear() === 2025 && t.exitDate.getMonth() === 4);
  const mayPLAvg = mayTradesAvg.reduce((sum, trade) => {
      const fxRate = trade.currency === 'USD' ? 1.35 : 1;
      return sum + (trade.realizedPL * fxRate);
  }, 0);
  console.log("May Realized P/L (AVERAGE, in CAD, estimated with 1.35 Fx):", mayPLAvg);


  console.log("\n--- LIFO Method ---");
  const lifoMatcher = new TradeMatcher({ lotMethod: "LIFO", includeFees: true });
  const lifoResult = lifoMatcher.matchTrades(activities);
  const totalPLLifo = lifoResult.closedTrades.reduce((sum, trade) => sum + trade.realizedPL, 0);
  console.log("Total Realized P/L (LIFO):", totalPLLifo);

  const mayTradesLifo = lifoResult.closedTrades.filter(t => t.exitDate.getFullYear() === 2025 && t.exitDate.getMonth() === 4);
  const mayPLLifo = mayTradesLifo.reduce((sum, trade) => {
      const fxRate = trade.currency === 'USD' ? 1.35 : 1;
      return sum + (trade.realizedPL * fxRate);
  }, 0);
  console.log("May Realized P/L (LIFO, in CAD, estimated with 1.35 Fx):", mayPLLifo);
}